name: Prime Academy CI/CD Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt -r requirements-dep.txt

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.PRIME_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "./"
          target: "/var/www/backend/api"
          strip_components: 1
          rm: false

      - name: Restart app on VPS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.PRIME_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            cd /var/www/backend/api
            
            # Create venv if doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            
            # Create backups directory
            mkdir -p backups
            
            echo "ğŸ“¦ Creating database backup (keeping last 7 days)..."
            # Extract password from .env
            export PGPASSWORD=$(grep DATABASE_URL .env | cut -d':' -f3 | cut -d'@' -f1)
            
            # Create backup with date
            BACKUP_FILE="backups/backup_$(date +%Y%m%d_%H%M%S).sql"
            pg_dump -U primeacademy -h localhost primeacademydb > "$BACKUP_FILE" 2>/dev/null && \
            echo "âœ“ Backup created: $BACKUP_FILE" || echo "âš ï¸ Backup skipped"
            
            unset PGPASSWORD
            
            # Keep only last 7 backups (delete older ones)
            ls -t backups/backup_*.sql | tail -n +8 | xargs -r rm
            echo "âœ“ Old backups cleaned (keeping last 7)"
            
            echo "ğŸ“š Installing dependencies..."
            pip install --upgrade pip wheel --quiet
            pip install -r requirements.txt -r requirements-dep.txt --quiet
            
            echo "ğŸ” Current migration status:"
            python3 manage.py showmigrations api
            
            echo "ğŸ—„ï¸ Running migrations with safe handling..."
            python3 manage.py migrate --fake-initial 2>/dev/null || python3 manage.py migrate --noinput
            
            echo "ğŸ“ Collecting static files..."
            python3 manage.py collectstatic --noinput
            
            echo "â™»ï¸ Restarting services..."
            sudo systemctl daemon-reload
            sudo systemctl restart primeacademy
            
            echo "âœ… Deployment complete!"
            
            # Wait for service to start
            sleep 3
            
            # Health check
            if sudo systemctl is-active --quiet primeacademy; then
              echo "âœ“ Service is running"
            else
              echo "âš ï¸ Service may have issues"
              sudo systemctl status primeacademy --no-pager
            fi
            
            echo "ğŸ“Š Final migration status:"
            python3 manage.py showmigrations api