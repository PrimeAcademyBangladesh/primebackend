name: Prime Academy CI/CD Deploy to VPS

on:
  push:
    branches:
      - main

env:
  PYTHON_VERSION: '3.11'
  DEPLOY_PATH: /var/www/backend/api

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: RUN TESTS & QUALITY CHECKS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Run Tests & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt -r requirements-dep.txt
          pip install pytest pytest-django pytest-cov flake8 pip-audit

      - name: Run linting (flake8)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run security audit
        run: |
          pip-audit --desc --skip-editable || echo "âš ï¸ Security audit found vulnerabilities (non-blocking)"

      - name: Check Django configuration
        run: |
          python manage.py check --deploy --fail-level WARNING
        env:
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DEBUG: "False"
          ALLOWED_HOSTS: "testserver,localhost,127.0.0.1"
          DATABASE_URL: "sqlite:///db.sqlite3"
          CORS_ALLOWED_ORIGINS: "http://testserver,http://localhost:5173"
          CSRF_TRUSTED_ORIGINS: "http://testserver,http://localhost:5173"
          FRONTEND_URL: "http://testserver"
          SITE_BASE_URL: "http://testserver:8080"
          BACKEND_URL: "http://testserver:8080"

      - name: Run tests with coverage
        run: |
          pytest --cov=api --cov-report=term-missing --cov-report=xml --cov-fail-under=70
        env:
          DJANGO_SETTINGS_MODULE: core.settings
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DEBUG: "True"
          ALLOWED_HOSTS: "localhost,127.0.0.1"
          DATABASE_URL: "sqlite:///db.sqlite3"

      - name: Check migrations
        run: |
          python manage.py makemigrations --check --dry-run
        env:
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DEBUG: "True"
          ALLOWED_HOSTS: "localhost,127.0.0.1"
          DATABASE_URL: "sqlite:///db.sqlite3"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: BUILD & PREPARE DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build & Prepare
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt -r requirements-dep.txt

      - name: Compile Python bytecode
        run: |
          python -m compileall -q .

      - name: Generate deployment manifest
        run: |
          echo "DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
          echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: BACKUP & DEPLOY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: build

    steps:
      # -----------------------------
      # âœ… STEP 1: Checkout Code
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # âœ… STEP 2: Setup Python
      # -----------------------------
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # -----------------------------
      # âœ… STEP 3: Install Dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt -r requirements-dep.txt

      # -----------------------------
      # âœ… STEP 4: BACKUP DATABASE & CODE
      # -----------------------------
      - name: ğŸ” Backup Database & Current Code
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.PRIME_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            # Create backup directory
            mkdir -p /var/www/backend/backups
            
            # Backup database
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            pg_dump -U primeacademy primeacademydb > /var/www/backend/backups/db_backup_${TIMESTAMP}.sql
            
            # Backup current code (if exists)
            if [ -d "${{ env.DEPLOY_PATH }}" ]; then
              tar -czf /var/www/backend/backups/code_backup_${TIMESTAMP}.tar.gz \
                -C /var/www/backend api --exclude=venv --exclude=media --exclude=staticfiles
            fi
            
            # Keep only last 5 backups
            cd /var/www/backend/backups
            ls -t db_backup_*.sql | tail -n +6 | xargs -r rm
            ls -t code_backup_*.tar.gz | tail -n +6 | xargs -r rm
            
            echo "âœ… Backup completed: db_backup_${TIMESTAMP}.sql"

      # -----------------------------
      # âœ… STEP 5: DEPLOY CODE USING RSYNC
      # -----------------------------
      - name: ğŸ“¦ Deploy to VPS using rsync
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avz --delete --exclude="venv" --exclude=".git" --exclude=".env" --exclude="media" --exclude="staticfiles" --exclude="__pycache__" --exclude="*.pyc" --exclude="db.sqlite3"
          path: ./
          remote_path: ${{ env.DEPLOY_PATH }}/
          remote_host: ${{ secrets.DEV_SSH_HOST }}
          remote_user: ${{ secrets.DEV_SSH_USER }}
          remote_key: ${{ secrets.PRIME_SSH_PRIVATE_KEY }}

      # -----------------------------
      # âœ… STEP 6: INSTALL DEPENDENCIES & MIGRATIONS
      # -----------------------------
      - name: ğŸ”§ Install Dependencies & Run Migrations
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.PRIME_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            cd ${{ env.DEPLOY_PATH }}

            # Create venv if it doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi

            # Activate venv
            source venv/bin/activate

            # Upgrade tools
            pip install --upgrade pip wheel

            # Install dependencies (with caching)
            pip install -r requirements.txt -r requirements-dep.txt --upgrade

            # Check migrations before running
            python3 manage.py migrate --check || echo "âš ï¸ Migration check failed"

            # Run migrations
            python3 manage.py migrate --noinput

            # Collect static files
            python3 manage.py collectstatic --noinput --clear

            echo "âœ… Dependencies installed and migrations completed"

      # -----------------------------
      # âœ… STEP 7: RESTART SERVICE
      # -----------------------------
      - name: ğŸ”„ Restart Gunicorn Service
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.PRIME_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            # Reload systemd
            systemctl daemon-reload

            # Restart Gunicorn service
            systemctl restart primeacademy

            # Wait for service to start
            sleep 5

            echo "âœ… Gunicorn service restarted"

      # -----------------------------
      # âœ… STEP 8: HEALTH CHECKS
      # -----------------------------
      - name: ğŸ¥ Run Health Checks
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.PRIME_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            # Check systemd service status
            if ! systemctl is-active --quiet primeacademy; then
              echo "âŒ Service is not running!"
              systemctl status primeacademy
              exit 1
            fi

            # Check if application responds
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8000/api/health/ || echo "000")
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "âŒ Health check failed! HTTP Code: $HTTP_CODE"
              echo "ğŸ“‹ Recent logs:"
              sudo journalctl -u primeacademy -n 50 --no-pager
              exit 1
            fi

            # Check for errors in logs
            ERROR_COUNT=$(journalctl -u primeacademy -n 100 --no-pager | grep -i "error" | wc -l)
            if [ "$ERROR_COUNT" -gt 5 ]; then
              echo "âš ï¸ Warning: Found $ERROR_COUNT errors in recent logs"
            fi

            echo "âœ… All health checks passed!"
            echo "âœ… Service Status: $(systemctl is-active primeacademy)"
            echo "âœ… HTTP Health Check: $HTTP_CODE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: POST-DEPLOY VERIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ğŸ” Verify Deployment
        run: |
          # Test external endpoint
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" http://45.85.250.92:8080/api/health/ || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… External health check passed!"
          else
            echo "âŒ External health check failed! HTTP Code: $HTTP_CODE"
            exit 1
          fi

      - name: ğŸ“¢ Send Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ URL: http://45.85.250.92:8080"

      - name: ğŸ“¢ Send Failure Notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ”„ Rollback may be required"
